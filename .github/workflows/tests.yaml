name: PyTests

on: [ push ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - id: changed
        continue-on-error: true
        name: Get changed files
        run: |
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})    
          echo "All changed files:"
          
          for file in $changed_files; do
            echo "$file"
          done
          
          changed_files=$(echo "$changed_files" | grep shipyard_blueprints | xargs -I {} dirname $(dirname {}))
          # Remove duplicates
          changed_files=$(echo "$changed_files" | sort | uniq)
          
          echo "Filtered changed directories:"
          
          for file in $changed_files; do
            echo "$file"
          done
          
          echo "CHANGED_FILES<<$changed_files" >> $GITHUB_ENV

      - name: No changes
        if: ${{ !env.CHANGED_FILES }}
        run: |
          echo "No file changes detected."
          exit 0

      - name: Install dependencies
        if: env.CHANGED_FILES
        run: |
          for dir in ${{ env.CHANGED_FILES }}; do
            cd ./$dir
            poetry install
          done

      - name: Run tests
        if: env.CHANGED_FILES
        run: |
          for dir in ${{ env.CHANGED_FILES }}; do
            cd ./$dir
            poetry run pytest
          done